# CirAni 项目架构设计文档

## 文档信息

- **项目名称**: CirAni - 电路科普动画引擎
- **版本**: 2.0
- **设计日期**: 2025-10-16
- **设计理念**: 参考 Artinchip D12x 工程结构,适配桌面应用场景

---

## 一、架构概述

### 1.1 设计目标

CirAni 是一个用于电路科普教学的动画引擎项目,旨在:

- **可视化电路原理**: 通过动画直观展示电流、电压、电场等抽象概念
- **模块化设计**: 便于扩展新的电路元件和动画效果
- **易于开源**: 清晰的代码结构,详细的文档,友好的贡献指南
- **跨平台**: 支持 Linux、Windows、macOS

### 1.2 参考架构

本项目架构参考了 **Artinchip D12x** 嵌入式工程的分层设计思想:

| D12x 层级        | CirAni 对应层级    | 说明                       |
|------------------|-------------------|---------------------------|
| kernel/          | core/             | 核心引擎层                 |
| bsp/peripheral/  | components/       | 元件库(硬件抽象)           |
| application/     | application/      | 应用演示                  |
| target/          | 无需对应           | CirAni 是桌面应用,无硬件目标 |
| tools/           | tools/            | 构建和开发工具             |
| packages/        | packages/         | 第三方依赖                 |

### 1.3 技术栈

- **编程语言**: C11
- **图形库**: raylib 5.x
- **构建系统**: SCons
- **配置系统**: Kconfig (可选)
- **版本控制**: Git

---

## 二、目录结构详解

```
CirAni/
├── .claude/           # Claude Code 配置
├── .vscode/           # VS Code 配置
├── application/       # 应用演示层
│   ├── demos/         # 示例程序
│   ├── src/           # 主程序源码
│   └── tutorials/     # 教程代码
├── build/             # 构建临时文件(不提交)
├── doc/               # 项目文档
│   └── design/        # 设计文档
├── output/            # 配置输出目录(不提交)
├── packages/          # 外部依赖包
│   └── CirAni/        # 项目自定义包
├── patches/           # 补丁文件
│   └── raylib/        # raylib 补丁
├── target/            # 目标平台相关
│   ├── configs/       # 平台配置
│   ├── desktop_linux/
│   ├── desktop_macos/
│   └── desktop_windows/
├── tools/             # 构建工具和脚本
│   ├── env/
│   ├── raylib_tools/
│   ├── scripts/
│   └── toolchain/
├── SConstruct         # SCons 主构建脚本
├── SConscript         # SCons 子构建脚本
├── build.sh           # Bash 快速构建脚本
├── .gitignore
├── Kconfig
├── ReleaseNote.md
└── README.md
```

**注意**: 当前为过渡阶段,尚未完全按照 2.0 架构重构。core/ 和 components/ 等目录将在后续版本中创建。

### 2.1 核心引擎层 (core/)

**设计思想**: 类似操作系统内核,提供基础服务

```
core/
├── animation/         # 动画引擎
│   ├── include/
│   │   ├── animator.h       # 动画器接口
│   │   ├── timeline.h       # 时间轴管理
│   │   ├── easing.h         # 缓动函数
│   │   └── tween.h          # 插值动画
│   ├── src/
│   │   ├── animator.c
│   │   ├── timeline.c
│   │   ├── easing.c
│   │   └── tween.c
│   └── SConscript
│
├── circuit/           # 电路仿真引擎
│   ├── include/
│   │   ├── circuit.h        # 电路抽象
│   │   ├── solver.h         # 方程求解器
│   │   ├── node.h           # 节点(Node)
│   │   └── element.h        # 元件基类
│   ├── src/
│   │   ├── circuit.c
│   │   ├── solver.c         # 基尔霍夫定律求解
│   │   ├── node.c
│   │   └── element.c
│   └── SConscript
│
├── graphics/          # 图形渲染层
│   ├── include/
│   │   ├── renderer.h       # 渲染器
│   │   ├── shape.h          # 基本图形
│   │   ├── text.h           # 文字渲染
│   │   └── effect.h         # 特效(辉光、粒子等)
│   ├── src/
│   │   ├── renderer.c
│   │   ├── shape.c
│   │   ├── text.c
│   │   └── effect.c
│   └── SConscript
│
├── common/            # 通用功能
│   ├── include/
│   │   ├── math_utils.h     # 数学工具
│   │   ├── logger.h         # 日志系统
│   │   ├── list.h           # 链表
│   │   ├── queue.h          # 队列
│   │   └── config.h         # 配置管理
│   ├── src/
│   │   ├── math_utils.c
│   │   ├── logger.c
│   │   ├── list.c
│   │   ├── queue.c
│   │   └── config.c
│   └── SConscript
│
└── SConscript
```

#### 核心模块职责:

1. **animation/** - 动画引擎
   - 时间轴管理(播放、暂停、快进、慢放)
   - 缓动函数(Ease In/Out, Bounce, Elastic 等)
   - 关键帧动画
   - 状态机(用于复杂动画)

2. **circuit/** - 电路仿真
   - 电路拓扑管理(节点、支路)
   - 基尔霍夫定律求解(KCL + KVL)
   - 瞬态分析(微分方程数值解)
   - 电流、电压计算

3. **graphics/** - 图形渲染
   - 对 raylib 的封装
   - 抗锯齿、渐变、阴影
   - 粒子系统(模拟电流)
   - UI 组件(按钮、滑块)

4. **common/** - 通用工具
   - 数学库(向量、矩阵)
   - 日志(分级、文件输出)
   - 数据结构
   - 配置文件解析

---

### 2.2 元件库 (components/)

**设计思想**: 类似 BSP 外设驱动,每个元件是独立模块

```
components/
├── basic/             # 基础元件
│   ├── resistor/
│   │   ├── resistor.h
│   │   ├── resistor.c
│   │   └── resistor_render.c
│   ├── capacitor/
│   ├── inductor/
│   ├── battery/
│   └── wire/
│
├── semiconductor/     # 半导体元件
│   ├── diode/
│   ├── transistor/
│   └── led/
│
├── integrated/        # 集成电路
│   ├── opamp/         # 运算放大器
│   └── logic/         # 逻辑门
│
└── SConscript
```

#### 元件设计规范:

每个元件包含三个部分:

1. **电气特性** (*.h)
   ```c
   typedef struct {
       Element base;        // 继承基类
       float resistance;    // 电阻值
       float voltage;       // 电压
       float current;       // 电流
   } Resistor;
   ```

2. **逻辑实现** (*.c)
   ```c
   // 计算电压-电流关系
   void resistor_update(Resistor* r) {
       r->voltage = r->current * r->resistance;  // 欧姆定律
   }
   ```

3. **视觉渲染** (*_render.c)
   ```c
   // 绘制电阻符号
   void resistor_render(Resistor* r, Renderer* renderer) {
       // 绘制矩形波浪线
       // 显示阻值标签
       // 绘制电流动画
   }
   ```

---

### 2.3 应用层 (application/)

**设计思想**: 演示和教程,类似 D12x 的 examples

```
application/
├── demos/             # 演示案例
│   ├── basic_circuit/
│   │   ├── main.c
│   │   └── README.md
│   ├── rc_circuit/
│   ├── rlc_circuit/
│   └── amplifier/
│
├── tutorials/         # 教程案例
│   ├── lesson01_intro/
│   │   ├── main.c
│   │   └── tutorial.md
│   ├── lesson02_ohm_law/
│   └── ...
│
├── src/               # 主程序
│   └── main.c
│
└── SConscript
```

---

### 2.4 资源文件 (assets/)

```
assets/
├── textures/          # 纹理
│   ├── background/
│   ├── particles/
│   └── ui/
│
├── fonts/             # 字体
│   ├── dejavu.ttf
│   └── consolas.ttf
│
├── sounds/            # 音效(可选)
│   ├── click.wav
│   └── buzz.wav
│
└── circuits/          # 电路配置文件
    ├── basic.json
    └── rc_filter.json
```

---

### 2.5 工具脚本 (tools/)

```
tools/
├── scripts/
│   ├── build.py           # 构建辅助
│   ├── config.py          # 配置管理
│   ├── export.py          # 导出动画为视频
│   └── component_gen.py   # 元件代码生成器
│
├── circuit_editor/        # 可视化电路编辑器(未来)
└── data_converter/        # 数据格式转换
```

---

## 三、模块接口设计

### 3.1 元件基类 (core/circuit/element.h)

```c
typedef enum {
    ELEMENT_RESISTOR,
    ELEMENT_CAPACITOR,
    ELEMENT_INDUCTOR,
    ELEMENT_BATTERY,
    ELEMENT_DIODE,
    // ...
} ElementType;

typedef struct Element {
    ElementType type;
    char name[32];
    int node_a;          // 连接的节点 A
    int node_b;          // 连接的节点 B
    float voltage;       // 电压
    float current;       // 电流

    // 虚函数(函数指针)
    void (*update)(struct Element* self);
    void (*render)(struct Element* self, void* renderer);
    void (*destroy)(struct Element* self);
} Element;
```

### 3.2 电路管理器 (core/circuit/circuit.h)

```c
typedef struct {
    Node* nodes;         // 节点数组
    Element** elements;  // 元件数组
    int node_count;
    int element_count;
} Circuit;

// 创建电路
Circuit* circuit_create(void);

// 添加元件
void circuit_add_element(Circuit* circuit, Element* element);

// 求解电路(基尔霍夫定律)
void circuit_solve(Circuit* circuit);

// 更新(时间步进)
void circuit_update(Circuit* circuit, float dt);

// 销毁
void circuit_destroy(Circuit* circuit);
```

### 3.3 动画管理器 (core/animation/animator.h)

```c
typedef struct {
    float time;          // 当前时间
    float duration;      // 持续时间
    float speed;         // 播放速度
    bool paused;
    bool loop;
} Animator;

// 创建动画器
Animator* animator_create(void);

// 更新时间
void animator_update(Animator* anim, float dt);

// 控制
void animator_play(Animator* anim);
void animator_pause(Animator* anim);
void animator_stop(Animator* anim);
void animator_set_speed(Animator* anim, float speed);
```

### 3.4 渲染器 (core/graphics/renderer.h)

```c
typedef struct {
    // raylib 相关
    Camera2D camera;
    RenderTexture2D target;
} Renderer;

// 初始化
Renderer* renderer_create(int width, int height);

// 绘制电路
void renderer_draw_circuit(Renderer* r, Circuit* circuit);

// 绘制电流粒子
void renderer_draw_current_flow(Renderer* r, Vector2 start, Vector2 end, float current);

// 绘制电压标签
void renderer_draw_voltage_label(Renderer* r, Vector2 pos, float voltage);

// 销毁
void renderer_destroy(Renderer* r);
```

---

## 四、构建系统设计

### 4.1 主构建脚本 (SConstruct)

```python
# 1. 读取项目配置
PRJ_NAME = 'CirAni'
PRJ_VERSION = '2.0'

# 2. 创建环境
env = DefaultEnvironment()

# 3. 配置编译选项
env.Append(CFLAGS=['-Wall', '-std=c11', '-O2'])
env.Append(LIBS=['raylib', 'GL', 'm', 'pthread'])

# 4. 递归构建各模块
Export('env')
objs = []
objs += SConscript('core/SConscript', variant_dir='build/core', duplicate=0)
objs += SConscript('components/SConscript', variant_dir='build/components', duplicate=0)
objs += SConscript('application/SConscript', variant_dir='build/application', duplicate=0)

# 5. 链接最终程序
program = env.Program(target='output/bin/CirAni', source=objs)
Default(program)
```

### 4.2 模块构建脚本示例 (core/animation/SConscript)

```python
Import('env')

src = Glob('src/*.c')
objs = env.Object(src)

env.Append(CPPPATH=['#/core/animation/include'])

Return('objs')
```

---

## 五、开发路线图

### 阶段 1: 基础架构 (当前)
- [x] 项目结构设计
- [ ] 创建目录结构
- [ ] 配置构建系统
- [ ] 实现核心基类

### 阶段 2: 核心引擎
- [ ] 动画引擎(时间轴、缓动)
- [ ] 电路仿真(基本电路分析)
- [ ] 图形渲染(基本绘制)
- [ ] 基础元件(R, L, C, 电源, 导线)

### 阶段 3: 功能扩展
- [ ] 更多元件(二极管、三极管、运放)
- [ ] 可视化配置(JSON 文件加载电路)
- [ ] 交互功能(鼠标拖拽、参数调节)
- [ ] 导出功能(导出为图片、视频)

### 阶段 4: 开源准备
- [ ] 完善文档(API 文档、教程、贡献指南)
- [ ] 单元测试
- [ ] 示例项目
- [ ] CI/CD 配置

---

## 六、与 D12x 架构对比

| 特性             | D12x (嵌入式)           | CirAni (桌面)           |
|------------------|------------------------|------------------------|
| **分层设计**     | ✓ kernel/bsp/app       | ✓ core/components/app  |
| **模块化**       | ✓ 按外设分模块          | ✓ 按元件分模块          |
| **配置系统**     | ✓ Kconfig              | ✓ Kconfig (可选)       |
| **构建系统**     | ✓ SCons                | ✓ SCons                |
| **硬件抽象**     | ✓ BSP HAL              | ✗ 无需硬件抽象          |
| **多目标支持**   | ✓ D12x/D13x/D21x       | ✗ 单一桌面平台          |
| **RTOS 支持**    | ✓ RT-Thread/FreeRTOS   | ✗ 无需 RTOS            |

---

## 七、开源规划

### 7.1 许可证
- **推荐**: MIT License (宽松,易于商业使用)
- **备选**: Apache 2.0 (专利保护)

### 7.2 文档要求
- README.md (项目介绍、快速开始)
- CONTRIBUTING.md (贡献指南)
- CODE_OF_CONDUCT.md (行为准则)
- API 文档(Doxygen)

### 7.3 代码规范
- C 代码风格: Linux Kernel Style
- 命名规范: 小写下划线(snake_case)
- 注释: 中英文双语

---

## 八、总结

CirAni 2.0 架构设计借鉴了成熟的嵌入式工程实践,同时针对桌面应用特点进行优化:

1. **清晰的分层**: core(引擎) → components(元件) → application(应用)
2. **高内聚低耦合**: 每个模块职责明确,接口清晰
3. **易于扩展**: 新增元件只需实现标准接口
4. **便于开源**: 规范的代码结构和详尽文档

下一步: **实施目录结构重构**

---

**文档版本**: v1.0
**更新日期**: 2025-10-16
**维护者**: CirAni Team
