# D12x 工程架构参考手册 - CirAni 实现指南

## 文档说明

本文档详细分析 Artinchip D12x 的工程架构,并提供 CirAni 项目的对照实现方案。

**使用方式**:
- 左侧为 D12x 的实际实现
- 右侧为 CirAni 应该如何实现
- 您可以参考左侧代码,自己编写右侧代码

---

## 一、目录结构对比

### D12x 目录结构
```
luban-lite/
├── application/          # 应用代码(按kernel分类)
│   ├── rt-thread/
│   ├── baremetal/
│   ├── freertos/
│   └── Kconfig
├── bsp/                  # 板级支持包
│   ├── artinchip/        # 芯片驱动
│   ├── common/           # 通用BSP
│   ├── peripheral/       # 外设驱动
│   ├── examples/         # 示例代码
│   ├── SConscript
│   └── Kconfig
├── kernel/               # 内核层
│   ├── rt-thread/
│   ├── baremetal/
│   ├── freertos/
│   └── common/
├── packages/             # 第三方包
│   ├── artinchip/        # 自有包(mpp, lvgl-ui等)
│   ├── third-party/      # 第三方包
│   ├── SConscript
│   └── Kconfig
├── target/               # 目标板配置
│   ├── d12x/
│   ├── d13x/
│   ├── d21x/
│   └── configs/          # defconfig文件
├── tools/
│   ├── scripts/          # Python构建脚本
│   │   └── aic_build.py  # 核心构建工具
│   └── env/              # 环境工具(未看到,但文档中提到)
├── patches/              # 补丁文件
├── doc/                  # 文档
├── SConstruct            # 主构建脚本
├── SConscript            # 根SConscript
└── Kconfig               # 根配置文件
```

### CirAni 目录结构(您要实现的)
```
CirAni/
├── application/          # 应用代码
│   ├── demos/            # 演示案例
│   │   └── basic_circuit/
│   ├── tutorials/        # 教程
│   └── src/              # 主程序(或移到demos中)
├── packages/             # 所有库
│   ├── CirAni/           # ★ 您的核心实现
│   │   ├── components/   # 电路元件
│   │   ├── animation/    # 动画引擎
│   │   ├── circuit/      # 电路仿真
│   │   ├── graphics/     # 渲染封装
│   │   ├── common/       # 通用工具
│   │   ├── raylib/       # raylib(软链接到/home/zane/src/raylib)
│   │   └── include/      # 对外API
│   ├── third-party/      # 其他第三方库
│   ├── SConscript
│   └── Kconfig
├── bsp/                  # 板级支持(可选)
│   └── desktop/
├── target/               # 工程配置
│   ├── desktop_linux/
│   ├── desktop_windows/
│   └── configs/
├── tools/
│   ├── scripts/          # Python脚本
│   │   └── cirani_build.py
│   ├── env/              # 环境工具
│   ├── onestep.sh
│   └── build.sh
├── patches/              # 补丁
├── doc/
├── build/                # 构建临时文件
├── output/               # 输出目录
│   └── bin/
├── SConstruct
├── SConscript
└── Kconfig
```

---

## 二、SConstruct 主构建脚本对比

### D12x 的 SConstruct (核心逻辑)

```python
# /home/zane/src/luban-lite_pro/luban-lite/SConstruct

import os
import sys

# 1. 获取项目根目录
AIC_ROOT = os.path.normpath(os.getcwd())

# 2. 导入自定义构建脚本
aic_script_path = os.path.join(AIC_ROOT, 'tools/scripts/')
sys.path.append(aic_script_path)
from aic_build import *

# 3. 读取项目配置(从.config或defconfig)
chk_prj_config(AIC_ROOT)
PRJ_CHIP, PRJ_BOARD, PRJ_KERNEL, PRJ_APP, PRJ_DEFCONFIG_NAME, PRJ_CUSTOM_LDS = get_prj_config(AIC_ROOT)
PRJ_NAME = PRJ_DEFCONFIG_NAME.replace('_defconfig','')
PRJ_OUT_DIR = 'output/' + PRJ_NAME + '/images/'

# 4. 导出变量供SConscript使用
Export('AIC_ROOT', 'PRJ_CHIP', 'PRJ_BOARD', 'PRJ_KERNEL', 'PRJ_APP', ...)

# 5. 设置环境变量
os.environ["AIC_ROOT"] = AIC_ROOT
os.environ["PRJ_CHIP"] = PRJ_CHIP
# ... 更多环境变量

# 6. 导入rtconfig(编译配置)
chip_path = os.path.join(AIC_ROOT, 'bsp/artinchip/sys/' + PRJ_CHIP)
sys.path.append(chip_path)
import rtconfig

# 7. 设置RTT_ROOT
RTT_ROOT = os.path.join(AIC_ROOT, 'kernel/rt-thread/')
sys.path.append(os.path.join(RTT_ROOT, 'tools'))
from building import *

# 8. 创建编译环境
env = Environment(
    tools = ['mingw'],
    AS   = rtconfig.AS,   ASFLAGS   = rtconfig.AFLAGS,
    CC   = rtconfig.CC,   CFLAGS   = rtconfig.CFLAGS,
    CXX  = rtconfig.CXX,  CXXFLAGS  = rtconfig.CXXFLAGS,
    AR   = rtconfig.AR,   ARFLAGS   = '-rc',
    LINK = rtconfig.LINK, LINKFLAGS = rtconfig.LFLAGS,
)

# 9. 准备构建环境
objs = PrepareBuilding(env, RTT_ROOT, has_libcpu=False)

# 10. 生成目标
DoBuilding(TARGET, objs)
```

### CirAni 的 SConstruct (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/SConstruct`

**实现要点**:
1. 获取项目根目录 `CIRANI_ROOT`
2. 导入 `tools/scripts/cirani_build.py` 中的辅助函数
3. 读取项目配置:
   - `PRJ_TARGET` (desktop_linux/desktop_windows/desktop_macos)
   - `PRJ_APP` (basic_circuit/rc_circuit等)
4. 创建编译环境(GCC + raylib)
5. 调用 `SConscript` 收集目标文件
6. 链接生成最终程序

**参考模板**(您自己填充细节):
```python
import os
import sys

# TODO: 1. 获取项目根目录
CIRANI_ROOT = ???

# TODO: 2. 导入自定义构建工具
cirani_script_path = ???
sys.path.append(cirani_script_path)
from cirani_build import *

# TODO: 3. 读取项目配置
PRJ_TARGET = ???  # 从哪里读?
PRJ_APP = ???

# TODO: 4. 导出变量
Export('CIRANI_ROOT', 'PRJ_TARGET', 'PRJ_APP')

# TODO: 5. 创建编译环境
env = DefaultEnvironment()
env.Append(CFLAGS=[???])
env.Append(LIBS=[???])  # raylib, GL, m, pthread等

# TODO: 6. 调用根SConscript
objs = SConscript('SConscript', variant_dir='build', duplicate=0)

# TODO: 7. 生成可执行文件
program = env.Program(target=???, source=objs)
Default(program)
```

---

## 三、根 SConscript 对比

### D12x 的根 SConscript

**文件**: `/home/zane/src/luban-lite_pro/luban-lite/SConscript`

```python
Import('AIC_ROOT')
Import('PRJ_CHIP')
Import('PRJ_BOARD')
Import('PRJ_KERNEL')
Import('PRJ_APP')
import os
from building import *

objs = []

# 1. chip (bsp/artinchip/sys/d12x)
rel_path = os.path.join('bsp/artinchip/sys/' + PRJ_CHIP, 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 2. board (target/d12x/demo88/)
rel_path = os.path.join('target/' + PRJ_CHIP, PRJ_BOARD, 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 3. kernel (kernel/rt-thread/)
rel_path = os.path.join('kernel', PRJ_KERNEL, 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 4. kernel/common
rel_path = os.path.join('kernel', 'common', 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 5. bsp
rel_path = os.path.join('bsp', 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 6. packages
rel_path = os.path.join('packages', 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# 7. application
rel_path = os.path.join('application', PRJ_KERNEL, PRJ_APP, 'SConscript')
abs_path = os.path.join(AIC_ROOT, rel_path)
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

Return('objs')
```

### CirAni 的根 SConscript (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/SConscript`

**实现要点**:
1. 导入变量 `CIRANI_ROOT`, `PRJ_TARGET`, `PRJ_APP`
2. 按顺序调用各模块的 SConscript:
   - packages/ (核心库)
   - bsp/ (可选)
   - target/ (目标配置)
   - application/ (应用)
3. 返回所有目标文件

**参考模板**:
```python
Import('CIRANI_ROOT')
Import('PRJ_TARGET')
Import('PRJ_APP')
import os

objs = []

# TODO: 1. packages (核心库: CirAni + raylib)
rel_path = ???
abs_path = ???
if os.path.isfile(abs_path):
    objs = objs + SConscript(rel_path)

# TODO: 2. bsp (可选)

# TODO: 3. target (目标配置)

# TODO: 4. application (应用)

Return('objs')
```

---

## 四、packages 模块对比

### D12x 的 packages/SConscript

**文件**: `/home/zane/src/luban-lite_pro/luban-lite/packages/SConscript`

```python
Import('AIC_ROOT')
Import('PRJ_KERNEL')
import os
from building import *

cwd = GetCurrentDir()
objs = []
list = os.listdir(cwd)

# 自动遍历子目录,寻找SConscript
for d in list:
    path = os.path.join(cwd, d)
    if os.path.isfile(os.path.join(path, 'SConscript')):
        objs = objs + SConscript(os.path.join(d, 'SConscript'))

Return('objs')
```

**说明**: 自动遍历 `packages/artinchip/` 和 `packages/third-party/`

### CirAni 的 packages/SConscript (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/packages/SConscript`

**实现要点**:
1. 遍历 `packages/CirAni/` 和 `packages/third-party/`
2. 或者显式调用 `packages/CirAni/SConscript`

**参考模板**:
```python
Import('CIRANI_ROOT')
import os

cwd = os.getcwd()  # 或 GetCurrentDir()
objs = []

# TODO: 方法1 - 自动遍历
# list = os.listdir(cwd)
# for d in list:
#     ...

# TODO: 方法2 - 显式调用
objs = objs + SConscript('CirAni/SConscript')
# objs = objs + SConscript('third-party/SConscript')

Return('objs')
```

---

## 五、packages/CirAni/SConscript (您的核心库)

### 参考 D12x 的 packages/artinchip/SConscript

D12x 的 artinchip 包也是自动遍历子目录:
```python
# 结构类似 packages/SConscript
# 遍历 mpp/, lvgl-ui/, env/ 等子目录
```

### CirAni 的 packages/CirAni/SConscript (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/packages/CirAni/SConscript`

**实现要点**:
1. 调用各子模块:
   - `components/SConscript` (元件库)
   - `animation/SConscript` (动画引擎)
   - `circuit/SConscript` (电路仿真)
   - `graphics/SConscript` (渲染)
   - `common/SConscript` (通用工具)
   - `raylib/SConscript` (raylib库)

**参考模板**:
```python
Import('CIRANI_ROOT')
import os

objs = []

# TODO: 调用各子模块
# objs += SConscript('components/SConscript')
# objs += SConscript('animation/SConscript')
# objs += SConscript('circuit/SConscript')
# objs += SConscript('graphics/SConscript')
# objs += SConscript('common/SConscript')
# objs += SConscript('raylib/SConscript')

Return('objs')
```

---

## 六、子模块 SConscript 示例

### 参考模板 (通用写法)

D12x 中每个子模块的 SConscript 基本格式:
```python
Import('rtconfig')
from building import *

cwd = GetCurrentDir()
src = Glob('*.c')  # 收集所有.c文件
CPPPATH = [cwd]    # 添加头文件路径

group = DefineGroup('ModuleName', src, depend=[''], CPPPATH=CPPPATH)
Return('group')
```

### CirAni 子模块 SConscript (您要实现的)

**示例**: `packages/CirAni/animation/SConscript`

```python
Import('CIRANI_ROOT')
import os

# TODO: 1. 获取当前目录
cwd = ???

# TODO: 2. 收集源文件
src = Glob('src/*.c')  # 或手动列出

# TODO: 3. 设置头文件路径
CPPPATH = [
    os.path.join(cwd, 'include'),
    # 其他依赖的头文件路径
]

# TODO: 4. 编译
env = ???  # 需要从上层导入
objs = env.Object(src, CPPPATH=CPPPATH)

Return('objs')
```

---

## 七、Kconfig 配置系统对比

### D12x 的根 Kconfig

**文件**: `/home/zane/src/luban-lite_pro/luban-lite/Kconfig`

```kconfig
mainmenu "ArtInChip Luban-Lite SDK Configuration"

menu "Project options"

config PRJ_DEFCONFIG_FILENAME
    string "Project defconfig file name"

config PRJ_CHIP
    string "Chip name"

config PRJ_BOARD
    string "Board name"

config PRJ_KERNEL
    string "Kernel name"

config PRJ_APP
    string "Application name"

endmenu

config PLATFORM_LUBANLITE
    bool
    default y

config PKGS_DIR
    string
    default "tools/env/packages"

# 引用子模块Kconfig
source "application/Kconfig"
source "packages/Kconfig"
source "bsp/Kconfig"
```

### CirAni 的根 Kconfig (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/Kconfig`

**实现要点**:
1. 定义项目配置选项:
   - `PRJ_TARGET` (desktop_linux/windows/macos)
   - `PRJ_APP` (basic_circuit等)
2. 引用子模块 Kconfig

**参考模板**:
```kconfig
mainmenu "CirAni Circuit Animation Engine Configuration"

menu "Project options"

config PRJ_TARGET
    string "Target platform"
    default "desktop_linux"
    help
        Select target platform: desktop_linux, desktop_windows, desktop_macos

config PRJ_APP
    string "Application name"
    default "basic_circuit"
    help
        Select application to build

endmenu

config PLATFORM_DESKTOP
    bool
    default y

# TODO: 引用子模块Kconfig
source "packages/Kconfig"
source "application/Kconfig"
source "target/Kconfig"
```

### packages/Kconfig

**D12x**:
```kconfig
menu "Local packages options"

source "packages/third-party/Kconfig"
source "packages/artinchip/Kconfig"

endmenu
```

**CirAni** (您要实现的):
```kconfig
menu "Packages Configuration"

source "packages/CirAni/Kconfig"
source "packages/third-party/Kconfig"

endmenu
```

---

## 八、tools/scripts/cirani_build.py (辅助工具)

### 参考 D12x 的 aic_build.py

**功能**:
1. 读取配置文件 (.config)
2. 提供辅助函数 (pr_err, pr_info, pr_warn)
3. 处理项目配置逻辑

**关键函数**:
```python
def chk_prj_config(root):
    """检查项目配置是否存在"""
    pass

def get_prj_config(root):
    """读取项目配置"""
    # 返回 PRJ_CHIP, PRJ_BOARD, PRJ_KERNEL, PRJ_APP 等
    pass
```

### CirAni 的 cirani_build.py (您要实现的)

**文件位置**: `/home/zane/project/raylib_pro/CirAni/tools/scripts/cirani_build.py`

**实现要点**:
1. 读取 `.config` 文件
2. 解析 `PRJ_TARGET` 和 `PRJ_APP`
3. 提供日志函数

**参考模板**:
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys

def pr_err(msg):
    print(f"\033[41;37m*** {msg}\033[0m")

def pr_info(msg):
    print(f"\033[47;30m>>> {msg}\033[0m")

def pr_warn(msg):
    print(f"\033[43;30m!!! {msg}\033[0m")

def chk_prj_config(root):
    """检查项目配置"""
    # TODO: 检查.config是否存在
    pass

def get_prj_config(root):
    """读取项目配置"""
    # TODO: 解析.config文件
    # 返回 PRJ_TARGET, PRJ_APP
    pass
```

---

## 九、raylib 集成方式

### 方案1: 软链接(推荐,便于开发)

```bash
cd packages/CirAni/raylib
ln -s /home/zane/src/raylib/src src
ln -s /home/zane/src/raylib/src/raylib.h raylib.h
```

### 方案2: 使用系统安装的 raylib

在 SConstruct 中:
```python
env.Append(LIBS=['raylib'])  # 链接系统库
env.Append(CPPPATH=['/usr/include'])  # 系统头文件
```

### 方案3: 编译 raylib 源码

在 `packages/CirAni/raylib/SConscript` 中编译 raylib

---

## 十、application 模块

### D12x 的 application

```
application/
├── rt-thread/
│   └── test_demo/
│       ├── main.c
│       └── SConscript
├── baremetal/
└── Kconfig
```

### CirAni 的 application (您要实现的)

```
application/
├── demos/
│   └── basic_circuit/
│       ├── main.c
│       ├── assets/        # 应用自己的资源
│       └── SConscript
├── tutorials/
└── src/                   # 或者放到demos中
```

**SConscript 示例**:
```python
Import('CIRANI_ROOT')
import os

src = ['main.c']
objs = env.Object(src)

Return('objs')
```

---

## 十一、实施步骤建议

### 阶段1: 最小可编译框架
1. 修改 `SConstruct` - 设置基本编译环境
2. 修改 `SConscript` - 调用 packages 和 application
3. 创建 `packages/CirAni/SConscript` - 返回空列表
4. 创建 `application/demos/basic_circuit/SConscript` - 编译main.c
5. 测试编译: `scons`

### 阶段2: 添加 raylib 支持
1. 创建 `packages/CirAni/raylib/SConscript`
2. 链接 raylib 库
3. 测试运行

### 阶段3: 完善模块
1. 逐步添加 animation, circuit, graphics, common 模块
2. 每个模块独立的 SConscript

### 阶段4: 配置系统
1. 完善 Kconfig 文件
2. 实现 `tools/scripts/cirani_build.py`
3. 支持多配置切换

---

## 十二、调试技巧

### 1. 打印调试信息
```python
# 在SConscript中
print("Debug: Current dir =", os.getcwd())
print("Debug: objs =", objs)
```

### 2. 查看SCons详细输出
```bash
scons --debug=explain  # 查看为什么重新编译
scons -Q               # 安静模式
scons -n               # 只显示命令,不执行
```

### 3. 查看编译命令
```python
env['CCCOM'] = '$CC -o $TARGET -c $CFLAGS $CCFLAGS $_CCCOMCOM $SOURCES'
```

---

## 十三、常见问题

### Q1: Import 变量找不到?
A: 确保在 SConstruct 中 Export 了变量,并且在 SConscript 中 Import

### Q2: 找不到头文件?
A: 检查 CPPPATH 设置,使用绝对路径

### Q3: 链接失败?
A: 检查 LIBS 和 LIBPATH,确保库存在

---

## 附录: 快速参考

### D12x 关键文件路径
- SConstruct: `/home/zane/src/luban-lite_pro/luban-lite/SConstruct`
- SConscript: `/home/zane/src/luban-lite_pro/luban-lite/SConscript`
- Kconfig: `/home/zane/src/luban-lite_pro/luban-lite/Kconfig`
- aic_build.py: `/home/zane/src/luban-lite_pro/luban-lite/tools/scripts/aic_build.py`

### CirAni 要创建的关键文件
- [ ] SConstruct (主构建脚本)
- [ ] SConscript (根SConscript)
- [ ] Kconfig (根配置)
- [ ] packages/SConscript
- [ ] packages/CirAni/SConscript
- [ ] packages/CirAni/raylib/SConscript
- [ ] application/demos/basic_circuit/SConscript
- [ ] tools/scripts/cirani_build.py

---

**文档版本**: v1.0
**创建日期**: 2025-10-16
**维护者**: CirAni Team

**使用建议**:
1. 先阅读本文档,理解 D12x 的架构
2. 对照左侧代码,自己编写右侧代码
3. 遇到问题参考 D12x 源码
4. 逐步迭代,先实现最小框架
